<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graph::Easy Simple Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        textarea, pre {
            width: 100%;
            min-height: 200px;
            font-family: monospace;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Graph::Easy WebAssembly Test</h1>

    <div id="status">Loading...</div>

    <h2>Input:</h2>
    <textarea id="input">[ A ] -> [ B ]
[ B ] -> [ C ]</textarea>

    <button onclick="test()">Test</button>

    <h2>Output:</h2>
    <pre id="output"></pre>

    <script src="webperl/webperl.js"></script>

    <script type="text/perl">
# Empty script to trigger initialization
1;
    </script>

    <script>
        Perl.addStateChangeListener(function(from, to) {
            document.getElementById('status').textContent = 'Perl state: ' + to;

            if (to === 'Ready') {
                // Load Graph::Easy module files
                loadModules();
            }
        });

        async function loadModules() {
            document.getElementById('status').textContent = 'Loading Graph::Easy...';

            const modules = [
                'lib/Graph/Easy.pm',
                'lib/Graph/Easy/As_ascii.pm',
                'lib/Graph/Easy/Base.pm',
                'lib/Graph/Easy/Node.pm',
                'lib/Graph/Easy/Edge.pm',
                'lib/Graph/Easy/Group.pm',
                'lib/Graph/Easy/Parser.pm',
                'lib/Graph/Easy/Layout.pm',
                'lib/Graph/Easy/Attributes.pm',
                'lib/Graph/Easy/Node/Anon.pm',
                'lib/Graph/Easy/Node/Empty.pm',
                'lib/Graph/Easy/Node/Cell.pm',
                'lib/Graph/Easy/Edge/Cell.pm',
                'lib/Graph/Easy/Group/Anon.pm',
                'lib/Graph/Easy/Group/Cell.pm',
                'lib/Graph/Easy/Layout/Chain.pm',
                'lib/Graph/Easy/Layout/Grid.pm',
                'lib/Graph/Easy/Layout/Repair.pm',
                'lib/Graph/Easy/Layout/Scout.pm',
                'lib/Graph/Easy/Layout/Force.pm',
                'lib/Graph/Easy/Layout/Path.pm',
                'lib/Graph/Easy/Parser/Graphviz.pm',
                'lib/Graph/Easy/Parser/VCG.pm',
                'lib/Graph/Easy/As_graphviz.pm',
                'lib/Graph/Easy/As_txt.pm',
                'lib/Graph/Easy/As_vcg.pm',
                'lib/Graph/Easy/As_graphml.pm'
            ];

            try {
                // Create directories
                FS.mkdir('/lib');
                FS.mkdir('/lib/Graph');
                FS.mkdir('/lib/Graph/Easy');
                FS.mkdir('/lib/Graph/Easy/Node');
                FS.mkdir('/lib/Graph/Easy/Edge');
                FS.mkdir('/lib/Graph/Easy/Group');
                FS.mkdir('/lib/Graph/Easy/Parser');
                FS.mkdir('/lib/Graph/Easy/Layout');

                // Fetch and write each module
                for (const modPath of modules) {
                    const response = await fetch(modPath);
                    const content = await response.text();
                    FS.writeFile('/' + modPath, content);
                    console.log('Loaded:', modPath);
                }

                document.getElementById('status').textContent = 'Ready! Click Test button.';
            } catch (e) {
                document.getElementById('status').textContent = 'Error: ' + e.message;
                console.error(e);
            }
        }

        function test() {
            const input = document.getElementById('input').value;
            document.getElementById('output').textContent = 'Converting...';

            try {
                const perlCode = `
                    use lib '/lib';
                    use Graph::Easy;

                    my $graph = Graph::Easy->new();
                    my $input = q{${input.replace(/\\/g, '\\\\').replace(/}/g, '\\}').replace(/\$/g, '\\$')}};

                    my $err = $graph->parse_from_text($input);
                    die "Parse error: $err" if $err;

                    print $graph->as_ascii();
                `;

                Perl.eval(perlCode);
                document.getElementById('output').textContent = 'Check console for output';
            } catch (e) {
                document.getElementById('output').textContent = 'Error: ' + e.message;
                console.error(e);
            }
        }
    </script>
</body>
</html>
